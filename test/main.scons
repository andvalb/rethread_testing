import os
from itertools import chain

def GetAbsolutePaths(filenames):
	return map(lambda f: File(f).srcnode().abspath, filenames)

def buildGoogleTest(env):
	env.Append(CPPPATH = ['#/thirdparty/googletest/googletest/include', '#/thirdparty/googletest/googlemock/include', '#/thirdparty/googletest/googletest', '#/thirdparty/googletest/googlemock'])
	googletest_files = Split('#/thirdparty/googletest/googletest/src/gtest-all.cc #/thirdparty/googletest/googlemock/src/gmock-all.cc')
	return env.StaticLibrary(googletest_files)

env = Environment(CXX = 'g++', CPPPATH = ['#', '#/rethread'], LINKFLAGS = '-pthread')
env.Append(CPPFLAGS = Split('-std=c++11 -ggdb -Werror=all -Werror=extra -Werror=pedantic -pedantic -pedantic-errors'))

forced_includes = GetAbsolutePaths(Split('helgrind_annotations.h'))
env.Append(CPPFLAGS = list(chain(map(lambda f: ['-include', f], forced_includes))))

source_files = Split('test.cpp')
object_files = env.Object(source_files)
for f in forced_includes:
	object_files = env.Depends(object_files, f)

test_runner = env.Program('test_runner', object_files, LIBS=[buildGoogleTest(env)])
env.Default(test_runner)
